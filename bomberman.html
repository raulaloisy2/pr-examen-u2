<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TBOI: Bomberman</title>
</head>

<canvas id="mycanvas"  width="1000" height="600"> </canvas>
<audio   id="miAudio">
     <source src="files/sounds/InnocenceGlitched.mp3" type="audio/mpeg"> </audio>
<audio   id="miBomba">
     <source src="files/sounds/bomba.mp3" type="audio/mpeg"> </audio>


<body style="background-color: black;">
</body>




<script>
//Variables 
    //Canvas , imagenes y audio
    var canvas = document.getElementById('mycanvas'); 
    var ctx = canvas.getContext('2d');
    var musica = document.getElementById('miAudio');
    var sonidoBomba = document.getElementById('miBomba');
    var imagenPlayer = new Image();
    imagenPlayer.src= "files/img/isaac.png";
    var imagenBomba = new Image();
    imagenBomba.src= "files/img/bomba.png";
    var imagenExplosion = new Image();
    imagenExplosion.src= "files/img/boom.png";
    
    
    //Gameplay
 
    var playerX=40 , playerY=40;
    var pause = false;
    var speed = 2;
    var dir=0;
    var bombaActual = null;
    
    //Clases

    class GenerarJugador {
        constructor( w, h) {
            this.w=w;
            this.h=h;
        }
    
    }

    class GenerarPared {
           constructor(x, y, rompible) {
        this.x = x;
        this.y = y;
        this.w = 40;
        this.h = 40;
        this.rompible = rompible;
        this.destruido = false;

       
            if (rompible) {
               // this.destruido=true;
                if(!this.destruido){
                    this.image = new Image();
                    this.image.src = "files/img/roca.png"; // Asegúrate de que la ruta sea correcta
                }else{
                    this.image = new Image();
                    this.image.src = "files/img/vacio.png"; // Asegúrate de que la ruta sea correcta
                }
            } else {
                this.image = new Image();
                this.image.src = "files/img/metal.png"; // Asegúrate de que la ruta sea correcta
            }
        }
    

    
        pintar(ctx) {
            // Verifica que la imagen se haya cargado correctamente antes de intentar dibujarla
            if (this.image.complete) {
                ctx.drawImage(this.image, this.x, this.y, 45, 45);
            }
        }

        //EVITA ATRAVESAR ELEMENTOS
        colisionConCuadro(player) {
            console.log(player.x)

            if (!this.destruido){

                if (playerX + player.w > this.x && 
                playerX < this.x + this.w &&
                playerY + player.h > this.y &&
                playerY < this.y + this.h) {
                // Colisión detectada
                switch (dir) {
                    case 87: // Tecla "W"
                        playerY += speed * 2;
                        break;
                    case 83: // Tecla "S"
                        playerY -= speed * 2;
                        break;
                    case 68: // Tecla "D"
                        playerX -= speed * 2;
                        break;
                    case 65: // Tecla "A"
                        playerX += speed * 2;
                        break;
                    default:
                        break;
                }
                dir = 0;
                return true;
            }
            
            }

            return false; // No hay colisión
        }

        static pintarParedes(ctx, paredes) {
            for (let i = 0; i < paredes.length; i++) {
                paredes[i].pintar(ctx);
            }
        }
    }


    class Bomba {
        constructor(x, y) {
            this.x = x;
            this.y = y;
            this.size = 35;
            this.frames = 145; // Aumentamos el número de cuadros de animación (145 originales + 50 nuevos)
            this.currentFrame = 0;
            this.explosion = false;
        }
    
        // Método para actualizar la animación de la bomba
        update() {
            if (!this.explosion) {
                // Incrementa el cuadro actual
                this.currentFrame++;
    
                // Si se ha alcanzado el último cuadro, marca la bomba como explotada
                if (this.currentFrame === this.frames) {
                    this.explosion = true;
                }
            }
        }

        reiniciar() {
            this.currentFrame = 0;
            this.explosion = false;
        }

        crearExplosionEnDireccion(dx, dy) {
            let explosionX = this.x;
            let explosionY = this.y;
    
            for (let i = 0; i < 3; i++) {
                explosionX += dx * 40;
                explosionY += dy * 40;
    
                // Verifica si la explosión alcanza una pared rompible
                const pared = buscarPared(explosionX, explosionY);
    
                if (pared && pared.rompible) {
                    if (!pared.destruido) {
                        pared.destruido = true;
                    }
                }
    
                // Dibuja la explosión en esa posición
                ctx.fillStyle = "red"; // Color de la explosión
                ctx.fillRect(explosionX - 5, explosionY - 5, 35, 35); // Tamaño del cuadro rojo
    
                // Verifica si la explosión alcanza al jugador
                if (explosionX === playerX && explosionY === playerY) {
                    // El jugador ha sido alcanzado por la explosión, puedes hacer algo aquí
                }
            }
        }
        
    
    }

    //OBJETOS DECLARADOS
    var player = new GenerarJugador(30,30);
    ctx.drawImage(imagenPlayer, 0, 0);
    let walls = []
    paredesOrilla(walls);
    paredesJuego(walls);
    var bomba = null;




//FUNCIONES 

//FONDO
    function drawBackground(){
        
        ctx.beginPath();
        ctx.fillStyle = "#6F5B52";
        ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.closePath();

    }

    function paredesOrilla(walls) {
        const borderWidth = 40; // Ancho de la pared
        const canvasWidth = canvas.width;
        const canvasHeight = canvas.height;
        // Pintar pared superior
        for (let x = 0; x < canvasWidth; x += borderWidth) {
            walls.push(new GenerarPared(x, 0));
        }
    
        // Pintar pared inferior
        for (let x = 0; x < canvasWidth; x += borderWidth) {
            walls.push(new GenerarPared(x, canvasHeight - borderWidth));
        }
    
        // Pintar pared izquierda
        for (let y = 0; y < canvasHeight; y += borderWidth) {
            walls.push(new GenerarPared(0, y));
        }
    
        // Pintar pared derecha
        for (let y = 0; y < canvasHeight; y += borderWidth) {
            walls.push(new GenerarPared(canvasWidth - borderWidth, y));
        }
    }

    function paredesJuego(walls) {
        const cuadriculaX = 14; // Número de bloques en el eje X
        const cuadriculaY = 8; // Número de filas en el eje Y
        const borderWidth = 40; // Ancho de la pared
        const canvasWidth = canvas.width - 80;
        const canvasHeight = canvas.height - 80;
        
        for (let y = 80; y < canvasHeight; y += borderWidth) {
            let rompibles = false; // Inicia con todas las columnas como rompibles en cada fila
            
            for (let x = 80; x < canvasWidth; x += borderWidth) {
                const cuadriculaXIndex = Math.floor(x / borderWidth) % cuadriculaX;
                const cuadriculaYIndex = Math.floor(y / borderWidth) % cuadriculaY;
    
                // Comprueba si estamos en una fila par o impar para alternar rompibles y no rompibles
                const enFilaPar = cuadriculaYIndex % 2 === 0;
    
                // Establece rompibles en función de la lógica deseada
                const rompible = enFilaPar ? rompibles : true;
    
                walls.push(new GenerarPared(x, y, rompible));
                
                // Alterna el valor de rompibles para la próxima columna en la misma fila
                rompibles = !rompibles;
            }
        }
    }
    
    // Para crear la disposición de bloques al estilo de Bomberman:
    paredesJuego(walls);
    
    
//VERIFICA EL ARREGLO DE WALLS SI UNO DE ELLOS TIENE UNA COLISIÓN
    function verificarColisiones() {
        for (var i = 0; i < walls.length; i++) {
            if (walls[i].colisionConCuadro(player)) {
                //walls[i].destruido=true;
                console.log("Colisión detectada con la pared " + i);
            }
        }
    }

    function drawBackground(){
        
        ctx.beginPath();
        ctx.fillStyle = "#6F5B52";
        ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.closePath();

    }
    //FUNCION REPINTAR
    function repaint() {
        if (!pause) {
            drawBackground();
            // Dibujar Player
            ctx.drawImage(imagenPlayer, playerX, playerY, 40, 45);
    
            ctx.fillStyle = "Black";
            // Dibujar Paredes
            GenerarPared.pintarParedes(ctx, walls);
    
            // Validar si la bomba actual existe y no ha explotado
            if (bombaActual !== null) {
                if (!bombaActual.explosion) {
                    ctx.drawImage(imagenBomba, bombaActual.x, bombaActual.y, bombaActual.size, bombaActual.size);
                } else {
                    // Dibuja la explosión usando la nueva imagen y ajustando el tamaño según sea necesario
                   // ctx.drawImage(imagenExplosion, bombaActual.x - 5, bombaActual.y - 5, bombaActual.size + 10, bombaActual.size + 10);
                }
            }
        } else {
            ctx.fillStyle = "Black";
            ctx.font = "30px Arial";
            ctx.fillText("P A U S A ", 180, 250);
            ctx.fillStyle = "rgba(138, 196, 172,0.1)";
            ctx.fillRect(0, 0, 500, 500);
        }
    }
    
    //Pintar Fondo
    drawBackground();

//
    function buscarPared(x, y) {
        for (let i = 0; i < walls.length; i++) {
            const pared = walls[i];
            if (!pared.destruido && pared.x === x && pared.y === y) {
                return pared;
            }
        }
        return null;
    }
    //LECTURA DEL TECLADO
    document.addEventListener("keydown", (e) => {

       
        //musica.play();        
        console.log(e.keyCode);

        if (e.keyCode === 69 && bombaActual === null) {        
            const bombaX = Math.floor((playerX + 20) / 40) * 40; // Centra la bomba en cuadrículas de 40x40
            const bombaY = Math.floor((playerY + 20) / 40) * 40; // Centra la bomba en cuadrículas
            bombaActual = new Bomba(bombaX, bombaY);
                }

        switch(e.keyCode){
            case 87:
            dir=e.keyCode;
                playerY-=speed;
                break;
            case 65:    
            dir=e.keyCode;
                playerX-=speed;
                break;
            case 83:
            dir=e.keyCode;
                playerY+=speed;
                break;
            case 68:
            dir=e.keyCode;
                playerX+8;
                break;
                case 81:
                console.log ("Pausa");
                if(!pause){
                    pause=true;
                }
                else{
                    pause=false;
                }
                break;

            default:
                break;
        };

});

    function crearExplosionesAlrededorDeBomba(bomba) {
        bomba.crearExplosionEnDireccion(0, -1); // Arriba
        bomba.crearExplosionEnDireccion(0, 1); // Abajo
        bomba.crearExplosionEnDireccion(-1, 0); // Izquierda
        bomba.crearExplosionEnDireccion(1, 0); // Derecha
    }
    //Verifica que el player no pueda salir de la pantalla
    function update() {
        if (pause == false) {
            switch (dir) {
                case 87:
                    if (!pause) {
                        playerY -= speed;
    
                        if (playerY < -50) {
                            playerY = 580;
                        }
                    }
                    break;
    
                case 83:
                    if (pause == false) {
                        playerY += speed;
    
                        if (playerY > 580) {
                            playerY = 0;
                        }
                    }
                    break;
    
                case 68:
                    if (pause == false) {
                        playerX += speed;
    
                        if (playerX > 1000) {
                            playerX = 0;
                        }
                    }
                    break;
    
                case 65:
                    if (pause == false) {
                        playerX -= speed;
    
                        if (playerX < -50) {
                            playerX = 980;
                        }
                    }
                    break;
    
                case 81:
                    console.log("Pausa");
                    if (!pause) {
                        pause = true;
                    } else {
                        pause = false;
                    }
                    break;
    
                default:
                    break;
            }
    
            // Llama a actualizar la bomba actual
            if (bombaActual !== null) {
                bombaActual.update();
                sonidoBomba.play();
    
                if (bombaActual.explosion) {
                    crearExplosionesAlrededorDeBomba(bombaActual);
                    bombaActual = null;
                }
            }
        }
    
        verificarColisiones();
        repaint();
        if (!pause) {
            // HUD SI NO HAY PAUSA
        }
    
        window.requestAnimationFrame(update);
    }
    



    //REQUEST ANIMATION
    window.requestAnimationFrame = (function () {
        return window.requestAnimationFrame ||
            window.webkitRequestAnimationFrame ||
            window.mozRequestAnimationFrame ||
            function (callback) {
                window.setTimeout(callback, 17);
            };
    }());
    window.requestAnimationFrame(update); 
</script>
</html>
